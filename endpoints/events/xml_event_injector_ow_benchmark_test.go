package events

import (
	"testing"

	"github.com/prebid/openrtb/v20/adcom1"
)

var (
	benchMarkVAST, testVAST string
	eventURLMap             map[string]string
	etreeEJ, fastxmlEJ      xmlEventInjector
)

func init() {
	benchMarkVAST = `<VAST version="3.0"><Ad id="2003321"><Wrapper><AdSystem version="21.04.13-10.27">LoopMe LTD</AdSystem><VASTAdTagURI><![CDATA[https://ad.doubleclick.net/ddm/pfadx/N389002.1938701LOOPME/B25537847.299180043;sz=0x0;ord=1618642841522;dc_lat=0;dc_rdid=00A10C46-C163-49B4-B160-677DA6472E99;tag_for_child_directed_treatment=;tfua=;dcmt=text/xml;dc_sdk_apis=7;dc_omid_p=Google/afma-sdk-i-v7.69.0;gdpr=0;gdpr_consent=;ltd=]]></VASTAdTagURI><Impression><![CDATA[https://tk0x1.com/sj/tr?et=INBOX_OPEN&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&name=dsp_video_loaded]]></Impression><Impression id="Client Impression"><![CDATA[https://tk0x1.com/sj/tr?et=BID_WIN&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&ip=86.163.224.0&id=607a87992864b0e4b952d573&client_id=pubmatic&a_ecp=15.0&a_id=${AUCTION_ID}&a_bid_id=${AUCTION_BID_ID}&a_price=${AUCTION_PRICE}&lmhref=https%3A%2F%2Ftk0x1.com%2Fsj%2Ftr%3Fet%3DBID_WIN%26meta%3DMjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5%26ctx%3DCiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ%26ip%3D86.163.224.0%26id%3D607a87992864b0e4e852d573%26client_id%3Dloopme%26a_ecp%3D15.0%26a_id%3D607a87992864b0e4b952d573%26a_bid_id%3D607a87992864b0e4e852d573%26a_price%3D15.0%26name%3Dimp_nurl&name=imp_vast]]></Impression><Creatives><Creative id="2092901" sequence="1"><Linear><TrackingEvents><Tracking event="thirdQuartile"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_75&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="thirdQuartile"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_75&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4]]></Tracking><Tracking event="firstQuartile"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_25&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="firstQuartile"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_25&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4]]></Tracking><Tracking event="mute"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_MUTE&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="pause"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_PAUSE&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="complete"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_COMPLETES&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="complete"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_COMPLETES&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4]]></Tracking><Tracking event="skip"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_SKIP&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&playtime=[CONTENTPLAYHEAD]]]></Tracking><Tracking event="start"><![CDATA[https://tk0x1.com/sj/tr?et=INBOX_OPEN&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&name=imp_video_start]]></Tracking><Tracking event="start"><![CDATA[https://track.loopme.me/sj/vt?vt=00A10C46-C163-49B4-B160-677DA6472E99]]></Tracking><Tracking event="start"><![CDATA[https://tk0x1.com/sj/vt?vt=00A10C46-C163-49B4-B160-677DA6472E99]]></Tracking><Tracking event="start"><![CDATA[https://tk0x1.com/sj/tr?et=BID_WIN&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&ip=86.163.224.0&id=607a87992864b0e4e852d573&client_id=loopme&a_ecp=15.0&a_id=607a87992864b0e4b952d573&a_bid_id=607a87992864b0e4e852d573&a_price=15.0&name=imp_vast&name=imp_video_start]]></Tracking><Tracking event="start"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_STARTS&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="start"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_STARTS&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4]]></Tracking><Tracking event="midpoint"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_50&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="midpoint"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_50&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4]]></Tracking><Tracking event="exitFullscreen"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_EXIT_FULLSCREEN&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="resume"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_RESUME&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="unmute"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_UNMUTE&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking><Tracking event="close"><![CDATA[https://tk0x1.com/sj/tr?et=AD_CLOSE&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&playtime=[CONTENTPLAYHEAD]]]></Tracking><Tracking event="fullscreen"><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_FULLSCREEN&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ]]></Tracking></TrackingEvents><VideoClicks><ClickTracking><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_CLICK&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&playtime=[CONTENTPLAYHEAD]]]></ClickTracking><ClickTracking><![CDATA[https://tk0x1.com/sj/go/607a87992864b0e4e852d573?meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&lmhref=&lmhref=about:blank]]></ClickTracking><ClickTracking><![CDATA[https://tk0x1.com/sj/go/607a87992864b0e4b952d573?meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&lmhref=about:blank]]></ClickTracking></VideoClicks></Linear></Creative></Creatives><Extensions><Extension type="AdVerifications"><AdVerifications><Verification vendor="loopme.com-omid"><JavaScriptResource apiFramework="omid" browserOptional="true"><![CDATA[https://i.loopme.me/html/omid/omid.js]]></JavaScriptResource><TrackingEvents><Tracking event="verificationNotExecuted"><![CDATA[https://tk0x1.com/sj/tr?et=CUSTOM&id=607a87992864b0e4b952d573&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&name=OMID_ERR&omid=1&mode=[REASON]]]></Tracking></TrackingEvents><VerificationParameters><![CDATA[{"measurable":"https://tk0x1.com/sj/tr?et=MEASURABLE&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&id=607a87992864b0e4b952d573&omid=1", "viewable":"https://tk0x1.com/sj/tr?et=AD_VIEWABLE&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&id=607a87992864b0e4b952d573&omid=1", "debug":"https://tk0x1.com/sj/tr?et=CUSTOM&name=omsdk_debug&meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&id=607a87992864b0e4b952d573&omid=1" }]]></VerificationParameters></Verification></AdVerifications></Extension></Extensions></Wrapper></Ad></VAST>`

	testVAST = `<VAST version="3.0"><Ad id="2003321"><Wrapper><AdSystem version="21.04.13-10.27">LoopMe LTD</AdSystem><VASTAdTagURI><![CDATA[https://ad.doubleclick.net/ddm/pfadx/N389002.1938701LOOPME/B25537847.299180043;sz=0x0;ord=1618642841522;dc_lat=0;dc_rdid=00A10C46-C163-49B4-B160-677DA6472E99;tag_for_child_directed_treatment=;tfua=;dcmt=text/xml;dc_sdk_apis=7;dc_omid_p=Google/afma-sdk-i-v7.69.0;gdpr=0;gdpr_consent=;ltd=]]></VASTAdTagURI><Creatives><Creative id="2092901" sequence="1"><Linear><TrackingEvents></TrackingEvents><VideoClicks><ClickTracking><![CDATA[https://tk0x1.com/sj/tr?et=VIDEO_CLICK&id=607a87992864b0e4e852d573&meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&playtime=[CONTENTPLAYHEAD]]]></ClickTracking><ClickTracking><![CDATA[https://tk0x1.com/sj/go/607a87992864b0e4e852d573?meta=MjE1OTIyMzo2NjE5MzQ6MDBBMTBDNDYtQzE2My00OUI0LUIxNjAtNjc3REE2NDcyRTk5&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGK6zKCD35IMBKgkIBRCQ3qwDGAo49-SDAUABAQ&lmhref=&lmhref=about:blank]]></ClickTracking><ClickTracking><![CDATA[https://tk0x1.com/sj/go/607a87992864b0e4b952d573?meta=MjA5MjkwMToxMDI3NTgwOjAwQTEwQzQ2LUMxNjMtNDlCNC1CMTYwLTY3N0RBNjQ3MkU5OQ&ctx=CiQwMEExMEM0Ni1DMTYzLTQ5QjQtQjE2MC02NzdEQTY0NzJFOTkSAkdCGPzbPiDl3n8qCAgBEODGWxgKOA1AAv4&lmhref=about:blank]]></ClickTracking></VideoClicks></Linear></Creative></Creatives></Wrapper></Ad></VAST>`
	eventURLMap = map[string]string{
		"firstQuartile": "http://example.com/tracking/firstQuartile?k1=v1&k2=v2",
		"midpoint":      "http://example.com/tracking/midpoint",
		"thirdQuartile": "http://example.com/tracking/thirdQuartile",
		"complete":      "http://example.com/tracking/complete",
		"start":         "http://company.tracker.com?eventId=2&appbundle=abc",
	}
	etreeEJ = &etreeEventInjector{nurlPresent: false, linearity: adcom1.LinearityLinear}
	fastxmlEJ = &fastXMLEventInjector{nurlPresent: false, linearity: adcom1.LinearityLinear}
}

func BenchmarkETreeVideoInjector(b *testing.B) {
	for i := 0; i < b.N; i++ {
		etreeEJ.Inject(benchMarkVAST, eventURLMap)
	}
}

func BenchmarkFastXMLVideoInjector(b *testing.B) {
	for i := 0; i < b.N; i++ {
		fastxmlEJ.Inject(benchMarkVAST, eventURLMap)
	}
}
