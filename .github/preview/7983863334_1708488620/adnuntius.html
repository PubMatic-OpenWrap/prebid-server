
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>adnuntius: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/PubMatic-OpenWrap/prebid-server/v2/adapters/adnuntius/adnuntius.go (89.1%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package adnuntius

import (
        "encoding/json"
        "fmt"
        "net/http"
        "net/url"
        "strconv"
        "strings"

        "github.com/buger/jsonparser"
        "github.com/prebid/openrtb/v19/openrtb2"
        "github.com/prebid/prebid-server/v2/adapters"
        "github.com/prebid/prebid-server/v2/config"
        "github.com/prebid/prebid-server/v2/errortypes"
        "github.com/prebid/prebid-server/v2/openrtb_ext"
        "github.com/prebid/prebid-server/v2/util/timeutil"
)

type QueryString map[string]string
type adapter struct {
        time      timeutil.Time
        endpoint  string
        extraInfo string
}
type adnAdunit struct {
        AuId       string    `json:"auId"`
        TargetId   string    `json:"targetId"`
        Dimensions [][]int64 `json:"dimensions,omitempty"`
        MaxDeals   int       `json:"maxDeals,omitempty"`
}

type extDeviceAdnuntius struct {
        NoCookies bool `json:"noCookies,omitempty"`
}

type Ad struct {
        Bid struct {
                Amount   float64
                Currency string
        }
        NetBid struct {
                Amount float64
        }
        GrossBid struct {
                Amount float64
        }
        DealID          string `json:"dealId,omitempty"`
        AdId            string
        CreativeWidth   string
        CreativeHeight  string
        CreativeId      string
        LineItemId      string
        Html            string
        DestinationUrls map[string]string
}

type AdUnit struct {
        AuId       string
        TargetId   string
        Html       string
        ResponseId string
        Ads        []Ad
        Deals      []Ad `json:"deals,omitempty"`
}

type AdnResponse struct {
        AdUnits []AdUnit
}
type adnMetaData struct {
        Usi string `json:"usi,omitempty"`
}
type adnRequest struct {
        AdUnits  []adnAdunit `json:"adUnits"`
        MetaData adnMetaData `json:"metaData,omitempty"`
        Context  string      `json:"context,omitempty"`
}

type RequestExt struct {
        Bidder adnAdunit `json:"bidder"`
}

const defaultNetwork = "default"
const defaultSite = "unknown"
const minutesInHour = 60

// Builder builds a new instance of the Adnuntius adapter for the given bidder with the given config.
func Builder(bidderName openrtb_ext.BidderName, config config.Adapter, server config.Server) (adapters.Bidder, error) <span class="cov8" title="1">{
        bidder := &amp;adapter{
                time:      &amp;timeutil.RealTime{},
                endpoint:  config.Endpoint,
                extraInfo: config.ExtraAdapterInfo,
        }

        return bidder, nil
}</span>

func (a *adapter) MakeRequests(request *openrtb2.BidRequest, reqInfo *adapters.ExtraRequestInfo) ([]*adapters.RequestData, []error) <span class="cov8" title="1">{
        return a.generateRequests(*request)
}</span>

func setHeaders(ortbRequest openrtb2.BidRequest) http.Header <span class="cov8" title="1">{

        headers := http.Header{}
        headers.Add("Content-Type", "application/json;charset=utf-8")
        headers.Add("Accept", "application/json")
        if ortbRequest.Device != nil </span><span class="cov8" title="1">{
                if ortbRequest.Device.IP != "" </span><span class="cov8" title="1">{
                        headers.Add("X-Forwarded-For", ortbRequest.Device.IP)
                }</span>
                <span class="cov8" title="1">if ortbRequest.Device.UA != "" </span><span class="cov8" title="1">{
                        headers.Add("user-agent", ortbRequest.Device.UA)
                }</span>
        }
        <span class="cov8" title="1">return headers</span>
}

func makeEndpointUrl(ortbRequest openrtb2.BidRequest, a *adapter, noCookies bool) (string, []error) <span class="cov8" title="1">{
        uri, err := url.Parse(a.endpoint)
        endpointUrl := a.endpoint
        if err != nil </span><span class="cov0" title="0">{
                return "", []error{fmt.Errorf("failed to parse Adnuntius endpoint: %v", err)}
        }</span>

        <span class="cov8" title="1">gdpr, consent, err := getGDPR(&amp;ortbRequest)
        if err != nil </span><span class="cov0" title="0">{
                return "", []error{fmt.Errorf("failed to parse Adnuntius endpoint: %v", err)}
        }</span>

        <span class="cov8" title="1">if !noCookies </span><span class="cov8" title="1">{
                var deviceExt extDeviceAdnuntius
                if ortbRequest.Device != nil &amp;&amp; ortbRequest.Device.Ext != nil </span><span class="cov8" title="1">{
                        if err := json.Unmarshal(ortbRequest.Device.Ext, &amp;deviceExt); err != nil </span><span class="cov0" title="0">{
                                return "", []error{fmt.Errorf("failed to parse Adnuntius endpoint: %v", err)}
                        }</span>
                }

                <span class="cov8" title="1">if deviceExt.NoCookies </span><span class="cov8" title="1">{
                        noCookies = true
                }</span>

        }

        <span class="cov8" title="1">_, offset := a.time.Now().Zone()
        tzo := -offset / minutesInHour

        q := uri.Query()
        if gdpr != "" </span><span class="cov8" title="1">{
                endpointUrl = a.extraInfo
                q.Set("gdpr", gdpr)
        }</span>

        <span class="cov8" title="1">if consent != "" </span><span class="cov8" title="1">{
                q.Set("consentString", consent)
        }</span>

        <span class="cov8" title="1">if noCookies </span><span class="cov8" title="1">{
                q.Set("noCookies", "true")
        }</span>

        <span class="cov8" title="1">q.Set("tzo", fmt.Sprint(tzo))
        q.Set("format", "json")

        url := endpointUrl + "?" + q.Encode()
        return url, nil</span>
}

func getImpSizes(imp openrtb2.Imp) [][]int64 <span class="cov8" title="1">{

        if len(imp.Banner.Format) &gt; 0 </span><span class="cov8" title="1">{
                sizes := make([][]int64, len(imp.Banner.Format))
                for i, format := range imp.Banner.Format </span><span class="cov8" title="1">{
                        sizes[i] = []int64{format.W, format.H}
                }</span>

                <span class="cov8" title="1">return sizes</span>
        }

        <span class="cov8" title="1">if imp.Banner.W != nil &amp;&amp; imp.Banner.H != nil </span><span class="cov8" title="1">{
                size := make([][]int64, 1)
                size[0] = []int64{*imp.Banner.W, *imp.Banner.H}
                return size
        }</span>

        <span class="cov0" title="0">return nil</span>
}

/*
Generate the requests to Adnuntius to reduce the amount of requests going out.
*/
func (a *adapter) generateRequests(ortbRequest openrtb2.BidRequest) ([]*adapters.RequestData, []error) <span class="cov8" title="1">{
        var requestData []*adapters.RequestData
        networkAdunitMap := make(map[string][]adnAdunit)
        headers := setHeaders(ortbRequest)
        var noCookies bool = false

        for _, imp := range ortbRequest.Imp </span><span class="cov8" title="1">{
                if imp.Banner == nil </span><span class="cov8" title="1">{
                        return nil, []error{&amp;errortypes.BadInput{
                                Message: fmt.Sprintf("ignoring imp id=%s, Adnuntius supports only Banner", imp.ID),
                        }}
                }</span>

                <span class="cov8" title="1">var bidderExt adapters.ExtImpBidder
                if err := json.Unmarshal(imp.Ext, &amp;bidderExt); err != nil </span><span class="cov0" title="0">{
                        return nil, []error{&amp;errortypes.BadInput{
                                Message: fmt.Sprintf("Error unmarshalling ExtImpBidder: %s", err.Error()),
                        }}
                }</span>

                <span class="cov8" title="1">var adnuntiusExt openrtb_ext.ImpExtAdnunitus
                if err := json.Unmarshal(bidderExt.Bidder, &amp;adnuntiusExt); err != nil </span><span class="cov8" title="1">{
                        return nil, []error{&amp;errortypes.BadInput{
                                Message: fmt.Sprintf("Error unmarshalling ExtImpValues: %s", err.Error()),
                        }}
                }</span>

                <span class="cov8" title="1">if adnuntiusExt.NoCookies == true </span><span class="cov8" title="1">{
                        noCookies = true
                }</span>

                <span class="cov8" title="1">network := defaultNetwork
                if adnuntiusExt.Network != "" </span><span class="cov8" title="1">{
                        network = adnuntiusExt.Network
                }</span>

                <span class="cov8" title="1">adUnit := adnAdunit{
                        AuId:       adnuntiusExt.Auid,
                        TargetId:   fmt.Sprintf("%s-%s", adnuntiusExt.Auid, imp.ID),
                        Dimensions: getImpSizes(imp),
                }
                if adnuntiusExt.MaxDeals &gt; 0 </span><span class="cov8" title="1">{
                        adUnit.MaxDeals = adnuntiusExt.MaxDeals
                }</span>
                <span class="cov8" title="1">networkAdunitMap[network] = append(
                        networkAdunitMap[network],
                        adUnit)</span>
        }

        <span class="cov8" title="1">endpoint, err := makeEndpointUrl(ortbRequest, a, noCookies)
        if err != nil </span><span class="cov0" title="0">{
                return nil, []error{&amp;errortypes.BadInput{
                        Message: fmt.Sprintf("failed to parse URL: %s", err),
                }}
        }</span>

        <span class="cov8" title="1">site := defaultSite
        if ortbRequest.Site != nil &amp;&amp; ortbRequest.Site.Page != "" </span><span class="cov8" title="1">{
                site = ortbRequest.Site.Page
        }</span>

        <span class="cov8" title="1">for _, networkAdunits := range networkAdunitMap </span><span class="cov8" title="1">{

                adnuntiusRequest := adnRequest{
                        AdUnits: networkAdunits,
                        Context: site,
                }

                ortbUser := ortbRequest.User
                if ortbUser != nil </span><span class="cov8" title="1">{
                        ortbUserId := ortbRequest.User.ID
                        if ortbUserId != "" </span><span class="cov8" title="1">{
                                adnuntiusRequest.MetaData.Usi = ortbRequest.User.ID
                        }</span>
                }

                <span class="cov8" title="1">adnJson, err := json.Marshal(adnuntiusRequest)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, []error{&amp;errortypes.BadInput{
                                Message: fmt.Sprintf("Error unmarshalling adnuntius request: %s", err.Error()),
                        }}
                }</span>

                <span class="cov8" title="1">requestData = append(requestData, &amp;adapters.RequestData{
                        Method:  http.MethodPost,
                        Uri:     endpoint,
                        Body:    adnJson,
                        Headers: headers,
                })</span>

        }

        <span class="cov8" title="1">return requestData, nil</span>
}

func (a *adapter) MakeBids(request *openrtb2.BidRequest, externalRequest *adapters.RequestData, response *adapters.ResponseData) (*adapters.BidderResponse, []error) <span class="cov8" title="1">{

        if response.StatusCode == http.StatusBadRequest </span><span class="cov8" title="1">{
                return nil, []error{&amp;errortypes.BadInput{
                        Message: fmt.Sprintf("Status code: %d, Request malformed", response.StatusCode),
                }}
        }</span>

        <span class="cov8" title="1">if response.StatusCode != http.StatusOK </span><span class="cov0" title="0">{
                return nil, []error{&amp;errortypes.BadServerResponse{
                        Message: fmt.Sprintf("Status code: %d, Something went wrong with your request", response.StatusCode),
                }}
        }</span>

        <span class="cov8" title="1">var adnResponse AdnResponse
        if err := json.Unmarshal(response.Body, &amp;adnResponse); err != nil </span><span class="cov8" title="1">{
                return nil, []error{err}
        }</span>

        <span class="cov8" title="1">bidResponse, bidErr := generateBidResponse(&amp;adnResponse, request)
        if bidErr != nil </span><span class="cov0" title="0">{
                return nil, bidErr
        }</span>

        <span class="cov8" title="1">return bidResponse, nil</span>
}

func getGDPR(request *openrtb2.BidRequest) (string, string, error) <span class="cov8" title="1">{

        gdpr := ""
        var extRegs openrtb_ext.ExtRegs
        if request.Regs != nil &amp;&amp; request.Regs.Ext != nil </span><span class="cov8" title="1">{
                if err := json.Unmarshal(request.Regs.Ext, &amp;extRegs); err != nil </span><span class="cov0" title="0">{
                        return "", "", fmt.Errorf("failed to parse ExtRegs in Adnuntius GDPR check: %v", err)
                }</span>
                <span class="cov8" title="1">if extRegs.GDPR != nil &amp;&amp; (*extRegs.GDPR == 0 || *extRegs.GDPR == 1) </span><span class="cov8" title="1">{
                        gdpr = strconv.Itoa(int(*extRegs.GDPR))
                }</span>
        }

        <span class="cov8" title="1">consent := ""
        if request.User != nil &amp;&amp; request.User.Ext != nil </span><span class="cov8" title="1">{
                var extUser openrtb_ext.ExtUser
                if err := json.Unmarshal(request.User.Ext, &amp;extUser); err != nil </span><span class="cov0" title="0">{
                        return "", "", fmt.Errorf("failed to parse ExtUser in Adnuntius GDPR check: %v", err)
                }</span>
                <span class="cov8" title="1">consent = extUser.Consent</span>
        }

        <span class="cov8" title="1">return gdpr, consent, nil</span>
}

func generateAdResponse(ad Ad, imp openrtb2.Imp, html string, request *openrtb2.BidRequest) (*openrtb2.Bid, []error) <span class="cov8" title="1">{

        creativeWidth, widthErr := strconv.ParseInt(ad.CreativeWidth, 10, 64)
        if widthErr != nil </span><span class="cov0" title="0">{
                return nil, []error{&amp;errortypes.BadInput{
                        Message: fmt.Sprintf("Value of width: %s is not a string", ad.CreativeWidth),
                }}
        }</span>

        <span class="cov8" title="1">creativeHeight, heightErr := strconv.ParseInt(ad.CreativeHeight, 10, 64)
        if heightErr != nil </span><span class="cov0" title="0">{
                return nil, []error{&amp;errortypes.BadInput{
                        Message: fmt.Sprintf("Value of height: %s is not a string", ad.CreativeHeight),
                }}
        }</span>

        <span class="cov8" title="1">price := ad.Bid.Amount

        var bidderExt adapters.ExtImpBidder
        if err := json.Unmarshal(imp.Ext, &amp;bidderExt); err != nil </span><span class="cov0" title="0">{
                return nil, []error{&amp;errortypes.BadInput{
                        Message: fmt.Sprintf("Error unmarshalling ExtImpBidder: %s", err.Error()),
                }}
        }</span>

        <span class="cov8" title="1">var adnuntiusExt openrtb_ext.ImpExtAdnunitus
        if err := json.Unmarshal(bidderExt.Bidder, &amp;adnuntiusExt); err != nil </span><span class="cov0" title="0">{
                return nil, []error{&amp;errortypes.BadInput{
                        Message: fmt.Sprintf("Error unmarshalling ExtImpValues: %s", err.Error()),
                }}
        }</span>

        <span class="cov8" title="1">if adnuntiusExt.BidType != "" </span><span class="cov8" title="1">{
                if strings.EqualFold(string(adnuntiusExt.BidType), "net") </span><span class="cov8" title="1">{
                        price = ad.NetBid.Amount
                }</span>
                <span class="cov8" title="1">if strings.EqualFold(string(adnuntiusExt.BidType), "gross") </span><span class="cov8" title="1">{
                        price = ad.GrossBid.Amount
                }</span>
        }

        <span class="cov8" title="1">adDomain := []string{}
        for _, url := range ad.DestinationUrls </span><span class="cov8" title="1">{
                domainArray := strings.Split(url, "/")
                domain := strings.Replace(domainArray[2], "www.", "", -1)
                adDomain = append(adDomain, domain)
        }</span>

        <span class="cov8" title="1">bid := openrtb2.Bid{
                ID:      ad.AdId,
                ImpID:   imp.ID,
                W:       creativeWidth,
                H:       creativeHeight,
                AdID:    ad.AdId,
                DealID:  ad.DealID,
                CID:     ad.LineItemId,
                CrID:    ad.CreativeId,
                Price:   price * 1000,
                AdM:     html,
                ADomain: adDomain,
        }
        return &amp;bid, nil</span>

}

func generateBidResponse(adnResponse *AdnResponse, request *openrtb2.BidRequest) (*adapters.BidderResponse, []error) <span class="cov8" title="1">{
        bidResponse := adapters.NewBidderResponseWithBidsCapacity(len(adnResponse.AdUnits))
        var currency string
        adunitMap := map[string]AdUnit{}

        for _, adnRespAdunit := range adnResponse.AdUnits </span><span class="cov8" title="1">{
                adunitMap[adnRespAdunit.TargetId] = adnRespAdunit
        }</span>

        <span class="cov8" title="1">for _, imp := range request.Imp </span><span class="cov8" title="1">{

                auId, _, _, err := jsonparser.Get(imp.Ext, "bidder", "auId")
                if err != nil </span><span class="cov0" title="0">{
                        return nil, []error{&amp;errortypes.BadInput{
                                Message: fmt.Sprintf("Error at Bidder auId: %s", err.Error()),
                        }}
                }</span>

                <span class="cov8" title="1">targetID := fmt.Sprintf("%s-%s", string(auId), imp.ID)
                adunit := adunitMap[targetID]

                if len(adunit.Ads) &gt; 0 </span><span class="cov8" title="1">{

                        ad := adunit.Ads[0]
                        currency = ad.Bid.Currency

                        adBid, err := generateAdResponse(ad, imp, adunit.Html, request)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, []error{&amp;errortypes.BadInput{
                                        Message: fmt.Sprintf("Error at ad generation"),
                                }}
                        }</span>

                        <span class="cov8" title="1">bidResponse.Bids = append(bidResponse.Bids, &amp;adapters.TypedBid{
                                Bid:     adBid,
                                BidType: "banner",
                        })

                        for _, deal := range adunit.Deals </span><span class="cov8" title="1">{
                                dealBid, err := generateAdResponse(deal, imp, deal.Html, request)
                                if err != nil </span><span class="cov0" title="0">{
                                        return nil, []error{&amp;errortypes.BadInput{
                                                Message: fmt.Sprintf("Error at ad generation"),
                                        }}
                                }</span>

                                <span class="cov8" title="1">bidResponse.Bids = append(bidResponse.Bids, &amp;adapters.TypedBid{
                                        Bid:     dealBid,
                                        BidType: "banner",
                                })</span>
                        }

                }

        }
        <span class="cov8" title="1">bidResponse.Currency = currency
        return bidResponse, nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
